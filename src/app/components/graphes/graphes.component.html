<!-- graphes.component.html -->
<div class="ola-layout">

  <!-- ===================== SIDEBAR ===================== -->
  <aside class="ola-sidebar">

    <div class="sidebar-brand">
      <img class="nav-logo" src="assets/images/ola.jpg" alt="OLA">
      <div class="nav-brand">
        <div class="nav-title">Dashboard</div>
        <div class="nav-sub">Logistique</div>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-link"
         routerLink="/accueil"
         routerLinkActive="active"
         [routerLinkActiveOptions]="{ exact: true }">
        <span class="sidebar-icon">üè†</span>
        <span class="sidebar-text">Accueil</span>
      </a>

      <a class="sidebar-link" routerLink="/dashboard" routerLinkActive="active">
        <span class="sidebar-icon">üìä</span>
        <span class="sidebar-text">KPI</span>
      </a>

      <a class="sidebar-link" routerLink="/anomalies" routerLinkActive="active">
        <span class="sidebar-icon">‚ö†Ô∏è</span>
        <span class="sidebar-text">Anomalies</span>
      </a>

      <a class="sidebar-link" routerLink="/graphes" routerLinkActive="active">
        <span class="sidebar-icon">üìà</span>
        <span class="sidebar-text">Graphes</span>
      </a>

      
    </nav>

    <div class="sidebar-spacer"></div>

    <div class="sidebar-profile">
      <div class="profile">
        <button class="profile-btn" type="button">
          <span class="avatar">M</span>
          <span class="profile-text">
            <span class="name">Manager Logistique</span>
            <span class="role">MANAGER</span>
          </span>
          <span class="chev">‚ñæ</span>
        </button>
        <div class="profile-menu">
          <a class="menu-item" routerLink="/profile">Profil</a>
          <a class="menu-item" routerLink="/settings">Param√®tres</a>
          <button class="menu-item danger" type="button">D√©connexion</button>
        </div>
      </div>
    </div>

  </aside>

  <!-- ===================== RIGHT ===================== -->
  <div class="ola-right">

    <!-- TOPBAR -->
    <header class="ola-topbar">
      <div class="topbar-left">
        <span class="topbar-page-label">Graphes (Vue synth√©tique)</span>
      </div>

      <div class="topbar-right">
        <div class="topbar-search">
          <svg class="search-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
          <input type="text" placeholder="Search" />
        </div>

        <button class="tb-btn" routerLink="/powerbi" title="Analyse avanc√©e Power BI">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 19h16v2H4v-2zm2-2h3V7H6v10zm5 0h3V3h-3v14zm5 0h3V11h-3v6z"/>
          </svg>
        </button>
      </div>
    </header>

    <!-- PAGE -->
    <div class="ola-page">

      <!-- ===================== FILTERS CARD ===================== -->
      <div class="filters-card">

        <!-- IMPORT -->
        <div class="import-row">
          <input #fileInput type="file" accept=".xlsx,.xls" (change)="onFileSelected($event)" hidden />
          <button class="btn-file" (click)="fileInput.click()">choose file</button>
          <span class="file-name">{{ selectedFile?.name || 'Aucun fichier choisi' }}</span>
          <button class="btn-import" (click)="importExcel()" [disabled]="!selectedFile || importing">
            {{ importing ? 'Import...' : 'Importer Excel' }}
          </button>
          <div class="import-msg" *ngIf="importMsg">{{ importMsg }}</div>
        </div>

        <div class="hint" *ngIf="!fileImported">
          Importez un fichier Excel pour afficher les filtres et les graphes.
        </div>

        <!-- FILTERS -->
        <div class="filters-grid" *ngIf="fileImported">
          <div class="field">
            <label>Pays</label>
            <select [(ngModel)]="selectedAffiliate" (change)="onAffiliateChange()">
              <option *ngFor="let a of affiliates" [value]="a">{{ a }}</option>
            </select>
          </div>

          <div class="field">
            <label>Ann√©e</label>
            <select [(ngModel)]="selectedYear" (change)="onYearChange()">
              <option *ngFor="let y of years" [value]="y">{{ y }}</option>
            </select>
          </div>

          <div class="field">
            <label>Category</label>
            <select [(ngModel)]="selectedCategory">
              <option value="ALL">ALL</option>
              <option *ngFor="let c of categories" [value]="c">{{ c }}</option>
            </select>
          </div>

          <!-- ===== NOUVEAU : s√©lecteur de type de graphique ===== -->
          <div class="field">
            <label>Type de graphique</label>
            <select [(ngModel)]="chartType">
              <option value="line">üìà Courbe (Line)</option>
              <option value="bar">üìä Barres (Bar)</option>
              
            </select>
          </div>

          <div class="actions">
            <button class="btn-apply"
                    (click)="applyGraphs()"
                    [disabled]="!selectedAffiliate || !selectedYear || loading">
              {{ loading ? 'Chargement...' : 'Appliquer' }}
            </button>

            <button class="btn-send" type="button" routerLink="/powerbi">
              Analyse avanc√©e
            </button>
          </div>
        </div>

        <div class="hint error" *ngIf="errorMsg">{{ errorMsg }}</div>
      </div>

      <!-- ===================== GRAPHS ===================== -->
      <!-- Chaque card n'appara√Æt que si elle a des donn√©es (hasXxx = true) -->
      <div class="graphs-grid" *ngIf="fileImported">

        <div class="graph-card" *ngIf="hasOtd">
          <div class="graph-title">On-Time Delivery Rate</div>
          <canvas id="otdChart"></canvas>
        </div>

        <div class="graph-card" *ngIf="hasVolume">
          <div class="graph-title">Total Volume M3</div>
          <canvas id="volumeChart"></canvas>
        </div>

        <div class="graph-card" *ngIf="hasUnitCost">
          <div class="graph-title">ACT vs PLAN Unit Fleet Cost</div>
          <canvas id="unitCostChart"></canvas>
        </div>

        <div class="graph-card" *ngIf="hasShe">
          <div class="graph-title">SHE Incidents (Contamination + Cross)</div>
          <canvas id="sheChart"></canvas>
        </div>

        <div class="graph-card" *ngIf="hasPayment">
          <div class="graph-title">Payment Incident Rate</div>
          <canvas id="paymentChart"></canvas>
        </div>

      </div>

      <div class="empty" *ngIf="fileImported && !loading && showEmptyGraphs">
        S√©lectionne les filtres puis clique sur <b>Appliquer</b>.
      </div>

    </div>
  </div>

</div>
<div class="ola-layout">

  <!-- ===================== SIDEBAR ===================== -->
  <aside class="ola-sidebar">
    <div class="sidebar-brand">
      <img class="nav-logo" src="assets/images/ola.jpg" alt="OLA">
      <div class="nav-brand">
        <div class="nav-title">Dashboard</div>
        <div class="nav-sub">Logistique</div>
      </div>
    </div>
    <nav class="sidebar-nav">
      <a class="sidebar-link" routerLink="/accueil" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }">
        <span class="sidebar-icon">üè†</span><span class="sidebar-text">Accueil</span>
      </a>
      <a class="sidebar-link" routerLink="/dashboard" routerLinkActive="active">
        <span class="sidebar-icon">üìä</span><span class="sidebar-text">KPI</span>
      </a>
      <a class="sidebar-link" routerLink="/anomalies" routerLinkActive="active">
        <span class="sidebar-icon">‚ö†Ô∏è</span><span class="sidebar-text">Anomalies</span>
      </a>
      <a class="sidebar-link" routerLink="/graphes" routerLinkActive="active">
        <span class="sidebar-icon">üìà</span><span class="sidebar-text">Graphes</span>
      </a>
    </nav>
    <div class="sidebar-spacer"></div>
    <div class="sidebar-profile">
      <div class="profile">
        <button class="profile-btn" type="button">
          <span class="avatar">M</span>
          <span class="profile-text">
            <span class="name">Manager Logistique</span>
            <span class="role">MANAGER</span>
          </span>
          <span class="chev">‚ñæ</span>
        </button>
        <div class="profile-menu">
          <a class="menu-item" routerLink="/profile">Profil</a>
          <a class="menu-item" routerLink="/settings">Param√®tres</a>
          <button class="menu-item danger" type="button">D√©connexion</button>
        </div>
      </div>
    </div>
  </aside>

  <!-- ===================== RIGHT ===================== -->
  <div class="ola-right">

    <!-- TOPBAR -->
    <header class="ola-topbar">
      <div class="topbar-left">
    <div class="page-title-group">
      <span class="topbar-page-label">KPI Dashboard</span>

      <button class="tb-resume-btn"
              type="button"
              (click)="scrollToSummary()">
        üìÑ R√©sum√© IA
      </button>
    </div>
  </div>
     
      
      <div class="topbar-right">
        <div class="topbar-search">
          <svg class="search-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
          <input type="text" placeholder="Search" />
        </div>
        <button class="tb-btn" title="Vue grille">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/>
            <rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/>
          </svg>
        </button>
        <button class="tb-btn notif" title="Notifications">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6V11c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
          </svg>
          <span class="badge">5</span>
        </button>
        <button class="tb-btn" title="Profil">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"/>
          </svg>
        </button>
      </div>
    </header>

    <!-- PAGE -->
    <div class="ola-page">

      <!-- FILTRES -->
      <div class="filters-card">
        <div class="import-row">
          <input #fileInput type="file" accept=".xlsx,.xls" (change)="onFileSelected($event)" hidden />
          <button class="btn-file" (click)="fileInput.click()">choose file</button>
          <span class="file-name">{{ selectedFile?.name || 'Aucun fichier choisi' }}</span>
          <button class="btn-import" (click)="importExcel()" [disabled]="!selectedFile || importing">
            {{ importing ? 'Import...' : 'Importer Excel' }}
          </button>
          <div class="import-msg" *ngIf="importMsg">{{ importMsg }}</div>
        </div>

        <div class="hint" *ngIf="!fileImported">
          Importez un fichier Excel pour afficher les filtres et les KPI.
        </div>

        <div class="filters-grid" *ngIf="fileImported">
          <div class="field">
            <label>Pays</label>
            <select [(ngModel)]="selectedAffiliate" (change)="onAffiliateChange()">
              <option *ngFor="let a of affiliates" [value]="a">{{ a }}</option>
            </select>
          </div>
          <div class="field">
            <label>Ann√©e</label>
            <select [(ngModel)]="selectedYear" (change)="onYearChange()">
              <option *ngFor="let y of years" [value]="y">{{ y }}</option>
            </select>
          </div>
          <div class="field">
            <label>Mois</label>
            <select [(ngModel)]="selectedMonth">
              <option value="ALL">ALL (AVG)</option>
              <option *ngFor="let m of months" [value]="m">{{ m }}</option>
            </select>
          </div>
          <div class="field">
            <label>Category</label>
            <select [(ngModel)]="selectedCategory">
              <option value="ALL">ALL</option>
              <option *ngFor="let c of categories" [value]="c">{{ c }}</option>
            </select>
          </div>
          <div class="actions">
            <button class="btn-apply"
                    (click)="apply()"
                    [disabled]="!selectedAffiliate || !selectedMonth || !selectedYear || loading">
              {{ loading ? 'Chargement...' : 'Appliquer' }}
            </button>
            <button class="btn-send" type="button" (click)="toggleMailForm()" [disabled]="sendingMail">
              {{ sendingMail ? 'Envoi...' : 'Envoyer au manager' }}
            </button>
          </div>
        </div>

        <div class="mail-card" *ngIf="fileImported && showMailForm">
          <div class="mail-grid">
            <div class="mail-field">
              <label>Email manager</label>
              <input type="email" [(ngModel)]="managerEmail" placeholder="manager.logistique@outlook.com">
            </div>
            <div class="mail-field">
              <label>Ann√©e</label>
              <input type="text" [(ngModel)]="mailYear" placeholder="2026">
            </div>
            <div class="mail-field">
              <label>Lien dashboard</label>
              <input type="text" [(ngModel)]="dashboardUrl" placeholder="http://localhost:4200/login">
            </div>
            <div class="mail-actions">
              <button class="btn-apply" type="button" (click)="sendMailToManager()" [disabled]="sendingMail || !managerEmail">
                {{ sendingMail ? 'Envoi...' : 'Envoyer' }}
              </button>
              <button class="btn-cancel" type="button" (click)="toggleMailForm()">Annuler</button>
            </div>
          </div>
          <div class="hint success" *ngIf="mailSuccess">{{ mailSuccess }}</div>
          <div class="hint error"   *ngIf="mailError">{{ mailError }}</div>
        </div>

        <div class="hint" *ngIf="errorMsg">{{ errorMsg }}</div>
      </div>

      <!-- ===================== KPI CARDS ===================== -->
      <div class="kpi-grid" *ngIf="fileImported">
        <div class="kpi-card"
             *ngFor="let k of kpis"
             [hidden]="!shouldDisplayKpi(k.kpiCode)"
             (click)="openKpiChart(k.kpiCode)">
          <div class="kpi-label">{{ prettyLabel(k.kpiCode) }}</div>
          <div class="kpi-value">{{ formatValue(k.value, k.kpiCode) }}</div>
          <div class="kpi-sub">{{ k.affiliate }} ‚Ä¢ {{ k.month }} {{ k.year }}</div>
        </div>
        <div class="empty" *ngIf="!loading && kpis.length === 0 && !errorMsg">
          S√©lectionne les filtres puis clique sur <b>Appliquer</b>.
        </div>
      </div>

      <!-- ===================== R√âSUM√â IA ===================== -->
      <div id="aiSummarySection" class="ai-summary-card" *ngIf="fileImported && (aiSummary || aiLoading || aiError)">

        <div class="ai-header">
          <div class="ai-badge-row">
            <span class="ai-icon">ü§ñ</span>
            <span class="ai-title">Analyse IA</span>
            <span class="ai-chip model">Groq ¬∑ LLaMA 3.3</span>
            <span class="ai-chip mode" *ngIf="!aiLoading && aiSummary">
              {{ selectedMonth === 'ALL' ? 'üìÖ R√©sum√© annuel' : 'üìÜ R√©sum√© ' + selectedMonth }}
            </span>
          </div>
          <div class="ai-meta-row" *ngIf="aiSummary && !aiLoading">
            <span class="ai-meta-text">
              {{ selectedAffiliate }} ¬∑ {{ selectedYear }}
              {{ selectedCategory !== 'ALL' ? ' ¬∑ ' + selectedCategory : '' }}
            </span>
            <button class="ai-refresh" (click)="loadAiSummary()" title="R√©g√©n√©rer">üîÑ</button>
          </div>
        </div>

        <div class="ai-loading" *ngIf="aiLoading">
          <div class="ai-dots"><span></span><span></span><span></span></div>
          <p>Analyse en cours...</p>
        </div>

        <div class="ai-err" *ngIf="aiError && !aiLoading">‚ö†Ô∏è {{ aiError }}</div>

        <div class="ai-body" *ngIf="aiSummary && !aiLoading" [innerHTML]="aiSummaryHtml"></div>

      </div>
      <!-- ===================== FIN R√âSUM√â IA ===================== -->

      <!-- ===================== KPI MODAL ===================== -->
      <div class="modal-backdrop" *ngIf="showChartModal" (click)="closeKpiChart()"></div>
      <div class="modal" *ngIf="showChartModal">
        <div class="modal-header">
          <div class="modal-title">{{ modalTitle }}</div>
          <button class="modal-close" (click)="closeKpiChart()">‚úï</button>
        </div>
        <div class="modal-body">
          <canvas id="kpiTrendChart"></canvas>
          <div class="hint error" *ngIf="modalError">{{ modalError }}</div>
        </div>
      </div>

    </div>
  </div>

</div>